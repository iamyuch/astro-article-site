---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Sidebar from '../../components/Sidebar.astro';
import Search from '../../components/Search.astro';
import { getAllTags, getArticlesByTag } from '../../utils/articles';

export async function getStaticPaths() {
  const tagMap = await getAllTags();
  
  return Array.from(tagMap.keys()).map(tag => ({
    params: { tag },
  }));
}

const { tag } = Astro.params;
const articles = await getArticlesByTag(tag);
---

<BaseLayout title={`标签: ${tag}`} description={`包含标签"${tag}"的所有文章`} keywords={[tag]}>
  <!-- 主容器 -->
  <div class="max-w-5xl mx-auto px-4 py-6 bg-white min-h-screen border-x border-gray-200 shadow-none">
    
    <!-- 头部：Logo 和 搜索 -->
    <Header />
    
    <div class="flex flex-col md:flex-row md:items-end justify-between mb-6">
      <div class="flex-grow"></div>
      <Search />
    </div>

    <!-- 双栏布局：左内容，右侧边栏 -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
      
      <!-- 主内容区 (占3份) -->
      <main class="md:col-span-3">
        
        <!-- 标签标题 -->
        <div class="mb-6">
          <h1 class="text-2xl font-bold border-b-2 border-black pb-2 mb-2">标签: {tag}</h1>
          <p class="text-sm text-gray-600">共 {articles.length} 篇文章</p>
        </div>
        
        <!-- 列表区块 -->
        <div class="mb-8">
          <!-- 列表容器 -->
          <ul class="space-y-0 text-base">
            {articles.map(article => (
              <li class="group py-2 border-b border-dotted border-gray-300 flex flex-col sm:flex-row sm:items-baseline gap-1 sm:gap-4 hover:bg-gray-50 transition-colors">
                <div class="flex-grow">
                  <a href={article.url} class="text-link hover:text-link-hover font-medium visited:text-link-visited text-lg">
                    {article.title}
                  </a>
                </div>
                {article.tags.length > 0 && (
                  <div class="flex gap-1 flex-wrap">
                    {article.tags.map(t => (
                      <a 
                        href={`/tag/${encodeURIComponent(t)}/`} 
                        class={`text-xs text-gray-500 hover:text-gray-800 bg-gray-100 px-1 border border-gray-200 rounded-none whitespace-nowrap ${t === tag ? 'bg-gray-300 font-bold' : ''}`}
                      >
                        #{t}
                      </a>
                    ))}
                  </div>
                )}
              </li>
            ))}
          </ul>
        </div>

      </main>

      <!-- 侧边栏 (占1份) -->
      <Sidebar />
    </div>

    <!-- 极简 Footer -->
    <footer class="mt-12 pt-6 border-t border-gray-300 text-center text-xs text-gray-500">
      <p class="mb-2">
        &copy; 2026 WikiFlow. Powered by <a href="https://astro.build" class="text-gray-600 underline">Astro</a>.
      </p>
      <p>
        <a href="#" class="hover:text-black hover:underline mr-2">关于</a>
        <a href="#" class="hover:text-black hover:underline mr-2">隐私政策</a>
        <a href="#" class="hover:text-black hover:underline">联系方式</a>
      </p>
    </footer>
  </div>
</BaseLayout>

<style>
  .text-link {
    color: #0000EE;
  }
  .text-link:visited,
  .visited\:text-link-visited:visited {
    color: #551A8B;
  }
  .text-link-hover,
  .text-link:hover,
  .hover\:text-link-hover:hover {
    color: #FF0000;
  }
</style>
